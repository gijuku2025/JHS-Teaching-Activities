<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JLPT Kanji Drag & Drop Drill</title>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; background:#f5f5f5; }
    h1,h2 { margin:0.5em 0; }
    button { padding:8px 14px; font-size:14px; cursor:pointer; }
    .hidden{display:none;}

    #selectionScreen{ padding:16px; }
    #controls{ position:sticky; top:0; background:#fff; padding:10px; border-bottom:1px solid #ccc; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    #kanjiGrid{ margin-top:16px; display:grid; grid-template-columns:repeat(auto-fill,minmax(48px,1fr)); gap:8px; }
    .kanjiTile{ background:#fff; border:1px solid #ccc; text-align:center; padding:8px 0; font-size:24px; cursor:pointer; user-select:none; position:relative; }
    .kanjiTile.selected{ background:#d0ebff; border-color:#339af0; }
    .kanjiTile input{ position:absolute; top:4px; right:4px; }

    #drillScreen{ padding:16px; }
    #topBar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    #drillArea{ display:flex; gap:24px; flex-wrap:wrap; }
    #kanjiPool{ display:flex; gap:10px; flex-wrap:wrap; max-width:300px; }
    .draggableKanji{ background:#fff; border:2px solid #333; font-size:32px; width:60px; height:60px; display:flex; align-items:center; justify-content:center; cursor:grab; }
    .dropZone{ background:#fff; border:2px dashed #999; padding:10px; min-width:160px; min-height:60px; display:flex; justify-content:space-between; gap:10px; }
    .dropZone.correct{ border-color:green; background:#e6ffe6; }
    .reading{ font-size:14px; line-height:1.4; }
  </style>
</head>
<body>

<div id="selectionScreen">
  <h1>JLPT Kanji Drill</h1>
  <div id="controls">
    <label><input type="checkbox" id="toggleN5" checked> N5</label>
    <label><input type="checkbox" id="toggleN4"> N4</label>
    <label><input type="checkbox" id="toggleN3"> N3</label>
    <button id="selectAll">Select All</button>
    <button id="clearAll">Clear</button>
    <span id="count">Selected: 0</span>
    <button id="startDrill">Start</button>
  </div>
  <div id="kanjiGrid"></div>
</div>

<div id="drillScreen" class="hidden">
  <div id="topBar">
    <div id="timer">Time: 0.0s</div>
    <div id="progress"></div>
  </div>
  <div id="drillArea">
    <div id="kanjiPool"></div>
    <div id="dropZones"></div>
  </div>
</div>

<script>
  /* ===== Kanji Data ===== */
  const kanjiData = {
    N5: [
      {k:'一',on:'イチ',kun:'ひと-'},{k:'二',on:'ニ',kun:'ふた-'},{k:'三',on:'サン',kun:'み-'},{k:'四',on:'ヨン',kun:'よ-'},{k:'五',on:'ゴ',kun:'いつ-'},
      {k:'六',on:'ロク',kun:'む-'},{k:'七',on:'ナナ',kun:'なな'},{k:'八',on:'ハチ',kun:'や-'},{k:'九',on:'キュウ',kun:'ここの-'},{k:'十',on:'ジュウ',kun:'とお'},
      {k:'百',on:'ヒャク',kun:''},{k:'千',on:'セン',kun:''},
      {k:'日',on:'ニチ',kun:'ひ'},{k:'月',on:'ゲツ',kun:'つき'},{k:'火',on:'カ',kun:'ひ'},{k:'水',on:'スイ',kun:'みず'},{k:'木',on:'モク',kun:'き'},{k:'金',on:'キン',kun:'かね'},{k:'土',on:'ド',kun:'つち'},
      {k:'人',on:'ジン',kun:'ひと'},{k:'年',on:'ネン',kun:'とし'},{k:'時',on:'ジ',kun:'とき'},{k:'分',on:'ブン',kun:'わ-かる'},{k:'今',on:'コン',kun:'いま'},
      {k:'大',on:'ダイ',kun:'おお-'},{k:'小',on:'ショウ',kun:'ちい-'},{k:'中',on:'チュウ',kun:'なか'},{k:'上',on:'ジョウ',kun:'うえ'},{k:'下',on:'カ',kun:'した'},
      {k:'左',on:'サ',kun:'ひだり'},{k:'右',on:'ウ',kun:'みぎ'},{k:'前',on:'ゼン',kun:'まえ'},{k:'後',on:'ゴ',kun:'あと'},
      {k:'山',on:'サン',kun:'やま'},{k:'川',on:'セン',kun:'かわ'},{k:'田',on:'デン',kun:'た'},{k:'口',on:'コウ',kun:'くち'},
      {k:'目',on:'モク',kun:'め'},{k:'耳',on:'ジ',kun:'みみ'},{k:'手',on:'シュ',kun:'て'},{k:'足',on:'ソク',kun:'あし'},
      {k:'力',on:'リョク',kun:'ちから'},{k:'男',on:'ダン',kun:'おとこ'},{k:'女',on:'ジョ',kun:'おんな'},{k:'子',on:'シ',kun:'こ'},
      {k:'学',on:'ガク',kun:'まな-ぶ'},{k:'校',on:'コウ',kun:''},{k:'先',on:'セン',kun:'さき'},{k:'生',on:'セイ',kun:'い-きる'},
      {k:'友',on:'ユウ',kun:'とも'},{k:'本',on:'ホン',kun:'もと'},
      {k:'行',on:'コウ',kun:'い-く'},{k:'来',on:'ライ',kun:'く-る'},{k:'帰',on:'キ',kun:'かえ-る'},
      {k:'見',on:'ケン',kun:'み-る'},{k:'聞',on:'ブン',kun:'き-く'},{k:'話',on:'ワ',kun:'はな-す'},
      {k:'読',on:'ドク',kun:'よ-む'},{k:'書',on:'ショ',kun:'か-く'},
      {k:'食',on:'ショク',kun:'た-べる'},{k:'飲',on:'イン',kun:'の-む'},
      {k:'買',on:'バイ',kun:'か-う'},{k:'出',on:'シュツ',kun:'で-る'},{k:'入',on:'ニュウ',kun:'はい-る'},
      {k:'休',on:'キュウ',kun:'やす-む'},{k:'何',on:'ナニ',kun:'なに'}
    ],

    N4: [
      {k:'会',on:'カイ',kun:'あ-う'},{k:'社',on:'シャ',kun:''},{k:'店',on:'テン',kun:'みせ'},{k:'駅',on:'エキ',kun:''},
      {k:'病',on:'ビョウ',kun:'やまい'},{k:'院',on:'イン',kun:''},{k:'仕',on:'シ',kun:'つか-える'},{k:'事',on:'ジ',kun:'こと'},
      {k:'働',on:'ドウ',kun:'はたら-く'},{k:'思',on:'シ',kun:'おも-う'},{k:'考',on:'コウ',kun:'かんが-える'},
      {k:'作',on:'サク',kun:'つく-る'},{k:'使',on:'シ',kun:'つか-う'},{k:'借',on:'シャク',kun:'か-りる'},
      {k:'貸',on:'タイ',kun:'か-す'},{k:'住',on:'ジュウ',kun:'す-む'},{k:'知',on:'チ',kun:'し-る'},
      {k:'待',on:'タイ',kun:'ま-つ'},{k:'持',on:'ジ',kun:'も-つ'},{k:'教',on:'キョウ',kun:'おし-える'},
      {k:'習',on:'シュウ',kun:'なら-う'},{k:'強',on:'キョウ',kun:'つよ-い'},{k:'弱',on:'ジャク',kun:'よわ-い'},
      {k:'早',on:'ソウ',kun:'はや-い'},{k:'速',on:'ソク',kun:'はや-い'},{k:'近',on:'キン',kun:'ちか-い'},
      {k:'遠',on:'エン',kun:'とお-い'},{k:'重',on:'ジュウ',kun:'おも-い'},{k:'軽',on:'ケイ',kun:'かる-い'},
      {k:'広',on:'コウ',kun:'ひろ-い'},{k:'狭',on:'キョウ',kun:'せま-い'},{k:'暗',on:'アン',kun:'くら-い'},
      {k:'明',on:'メイ',kun:'あか-るい'},{k:'立',on:'リツ',kun:'た-つ'},{k:'歩',on:'ホ',kun:'ある-く'},
      {k:'走',on:'ソウ',kun:'はし-る'},{k:'止',on:'シ',kun:'と-まる'},{k:'起',on:'キ',kun:'お-きる'},
      {k:'寝',on:'シン',kun:'ね-る'},{k:'洗',on:'セン',kun:'あら-う'},{k:'売',on:'バイ',kun:'う-る'},
      {k:'送',on:'ソウ',kun:'おく-る'},{k:'通',on:'ツウ',kun:'とお-る'},
      {k:'始',on:'シ',kun:'はじ-める'},{k:'終',on:'シュウ',kun:'お-わる'},
      {k:'開',on:'カイ',kun:'ひら-く'},{k:'閉',on:'ヘイ',kun:'し-める'},
      {k:'答',on:'トウ',kun:'こた-える'},{k:'問',on:'モン',kun:'と-う'}
    ],

    N3: [
      {k:'政',on:'セイ',kun:''},{k:'治',on:'ジ',kun:'おさ-める'},{k:'経',on:'ケイ',kun:'へ-る'},{k:'済',on:'サイ',kun:'す-む'},
      {k:'法',on:'ホウ',kun:''},{k:'律',on:'リツ',kun:''},{k:'議',on:'ギ',kun:''},{k:'員',on:'イン',kun:''},
      {k:'情',on:'ジョウ',kun:'なさ-け'},{k:'報',on:'ホウ',kun:''},{k:'決',on:'ケツ',kun:'き-める'},{k:'定',on:'テイ',kun:'さだ-める'},
      {k:'増',on:'ゾウ',kun:'ふ-える'},{k:'減',on:'ゲン',kun:'へ-る'},{k:'変',on:'ヘン',kun:'か-わる'},
      {k:'対',on:'タイ',kun:''},{k:'関',on:'カン',kun:'かか-わる'},{k:'比',on:'ヒ',kun:'くら-べる'},
      {k:'質',on:'シツ',kun:''},{k:'量',on:'リョウ',kun:'はか-る'},{k:'費',on:'ヒ',kun:'つい-やす'},
      {k:'設',on:'セツ',kun:'もう-ける'},{k:'備',on:'ビ',kun:'そな-える'},
      {k:'表',on:'ヒョウ',kun:'あらわ-す'},{k:'現',on:'ゲン',kun:'あらわ-れる'},
      {k:'認',on:'ニン',kun:'みと-める'},{k:'確',on:'カク',kun:'たし-か'},
      {k:'危',on:'キ',kun:'あぶ-ない'},{k:'守',on:'シュ',kun:'まも-る'},
      {k:'歴',on:'レキ',kun:''},{k:'史',on:'シ',kun:''},
      {k:'常',on:'ジョウ',kun:'つね'},{k:'必',on:'ヒツ',kun:'かなら-ず'},{k:'要',on:'ヨウ',kun:'い-る'}
    ]
  };

  const grid = document.getElementById('kanjiGrid');
  const countSpan = document.getElementById('count');

  function renderGrid() {
    grid.innerHTML = '';
    const levels = [];
    if (document.getElementById('toggleN5').checked) levels.push('N5');
    if (document.getElementById('toggleN4').checked) levels.push('N4');
    if (document.getElementById('toggleN3').checked) levels.push('N3');

    levels.forEach(level => {
      kanjiData[level].forEach(entry => {
        const tile = document.createElement('div');
        tile.className = 'kanjiTile';
        tile.textContent = entry.k;

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        tile.appendChild(checkbox);

        tile.onclick = () => {
          checkbox.checked = !checkbox.checked;
          tile.classList.toggle('selected', checkbox.checked);
          updateCount();
        };

        tile.dataset.kanji = entry.k;
        tile.dataset.on = entry.on;
        tile.dataset.kun = entry.kun;
        grid.appendChild(tile);
      });
    });
    updateCount();
  }

  function updateCount() {
    countSpan.textContent = `Selected: ${document.querySelectorAll('.kanjiTile.selected').length}`;
  }

  document.getElementById('toggleN5').onchange = renderGrid;
  document.getElementById('toggleN4').onchange = renderGrid;
  document.getElementById('toggleN3').onchange = renderGrid;

  document.getElementById('selectAll').onclick = () => {
    document.querySelectorAll('.kanjiTile').forEach(t => {
      t.classList.add('selected');
      t.querySelector('input').checked = true;
    });
    updateCount();
  };

  document.getElementById('clearAll').onclick = () => {
    document.querySelectorAll('.kanjiTile').forEach(t => {
      t.classList.remove('selected');
      t.querySelector('input').checked = false;
    });
    updateCount();
  };

    renderGrid();

  /* ===== Drill Logic ===== */
  const startBtn = document.getElementById('startDrill');
  const selectionScreen = document.getElementById('selectionScreen');
  const drillScreen = document.getElementById('drillScreen');
  const kanjiPool = document.getElementById('kanjiPool');
  const dropZones = document.getElementById('dropZones');
  const timerEl = document.getElementById('timer');
  const progressEl = document.getElementById('progress');

  let startTime = null;
  let timerId = null;
  let total = 0;
  let solved = 0;

  function startTimer() {
    startTime = performance.now();
    timerId = requestAnimationFrame(updateTimer);
  }

  function updateTimer(now) {
    const elapsed = (now - startTime) / 1000;
    timerEl.textContent = `Time: ${elapsed.toFixed(1)}s`;
    timerId = requestAnimationFrame(updateTimer);
  }

  function stopTimer() {
    cancelAnimationFrame(timerId);
  }

  startBtn.onclick = () => {
    const selected = [...document.querySelectorAll('.kanjiTile.selected')];
    if (!selected.length) return;

    selectionScreen.classList.add('hidden');
    drillScreen.classList.remove('hidden');

    kanjiPool.innerHTML = '';
    dropZones.innerHTML = '';
    solved = 0;
    total = selected.length;
    progressEl.textContent = `0 / ${total}`;

    const shuffled = selected.sort(() => Math.random() - 0.5);

    shuffled.forEach(tile => {
      const k = tile.dataset.kanji;
      const on = tile.dataset.on;
      const kun = tile.dataset.kun;

      const drag = document.createElement('div');
      drag.className = 'draggableKanji';
      drag.textContent = k;
      drag.draggable = true;

      drag.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', k);
        e.dataTransfer.setData('application/on', on);
        e.dataTransfer.setData('application/kun', kun);
        drag.classList.add('dragging');
      });

      drag.addEventListener('dragend', () => {
        drag.classList.remove('dragging');
      });

      kanjiPool.appendChild(drag);

      const zone = document.createElement('div');
      zone.className = 'dropZone';
      zone.dataset.answer = k;

      const reading = document.createElement('div');
      reading.className = 'reading';
      reading.innerHTML = `<div>${on}</div><div>${kun}</div>`;

      zone.appendChild(reading);

      zone.addEventListener('dragover', e => e.preventDefault());

      zone.addEventListener('drop', e => {
        e.preventDefault();
        const droppedKanji = e.dataTransfer.getData('text/plain');
        const draggedEl = document.querySelector('.draggableKanji.dragging');

        if (droppedKanji === zone.dataset.answer) {
          zone.classList.add('correct');
          zone.appendChild(draggedEl);
          draggedEl.draggable = false;
          solved++;
          progressEl.textContent = `${solved} / ${total}`;
          if (solved === total) stopTimer();
        } else {
          /* A: snap back immediately */
          kanjiPool.appendChild(draggedEl);
        }
      });

      dropZones.appendChild(zone);
    });

    startTimer();
  };
</script>
</body>
</html>
