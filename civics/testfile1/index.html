<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>JLPT Kanji Drag Drill</title>
<style>
    body { font-family: -apple-system, BlinkMacSystemFont, system-ui, "Segoe UI", sans-serif; margin: 0; background:#f5f5f5; }
    h1,h2 { margin:0.5em 0; }
    button { padding:12px 16px; font-size:16px; cursor:pointer; border-radius:10px; }
    .hidden{display:none;}

    #selectionScreen{ padding:14px; }
    #controls{ position:sticky; top:0; background:#fff; padding:10px; border-bottom:1px solid #ccc; display:flex; gap:10px; flex-wrap:wrap; align-items:center; z-index:10; }
    #kanjiGrid{ margin-top:16px; display:grid; grid-template-columns:repeat(auto-fill,minmax(52px,1fr)); gap:10px; }
    .kanjiTile{ background:#fff; border:2px solid #ccc; text-align:center; padding:10px 0; font-size:26px; cursor:pointer; user-select:none; border-radius:12px; }
    .kanjiTile.selected{ background:#d0ebff; border-color:#339af0; }

    #drillScreen{ padding:14px; }
    #topBar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; font-size:16px; }
    #drillArea{ display:flex; flex-direction:column; gap:20px; }
    #kanjiPool{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }

    .draggableKanji{ background:#fff; border:3px solid #333; font-size:36px; width:72px; height:72px; display:flex; align-items:center; justify-content:center; border-radius:14px; cursor:pointer; }
    .draggableKanji.active{ background:#fff3bf; border-color:#f59f00; }

    #dropZones{ display:flex; flex-direction:column; gap:12px; }
    .dropZone{ background:#fff; border:3px dashed #999; padding:12px; min-height:72px; border-radius:14px; display:flex; justify-content:space-between; align-items:center; font-size:15px; }
    .dropZone.correct{ border-color:#2f9e44; background:#e6ffe6; }
    .reading{ font-size:14px; line-height:1.4; }
  </style>
</head>
<body>

<div id="selectionScreen">
  <h1>JLPT Kanji Drill</h1>
  <div id="controls">
    <label><input type="checkbox" id="toggleN5" checked> N5</label>
    <label><input type="checkbox" id="toggleN4"> N4</label>
    <label><input type="checkbox" id="toggleN3"> N3</label>
    <button id="selectAll">Select All</button>
    <button id="clearAll">Clear</button>
    <span id="count">Selected: 0</span>
    <button id="startDrill">Start</button>
  </div>
  <div id="kanjiGrid"></div>
</div>

<div id="drillScreen" class="hidden">
  <div id="topBar">
    <div id="timer">Time: 0.0s</div>
    <div id="progress"></div>
  </div>
  <div id="drillArea">
    <div id="kanjiPool"></div>
    <div id="dropZones"></div>
  </div>
</div>

<script>
  /* ===== Kanji Data (unchanged) ===== */
  const kanjiData = window.kanjiData || {};

  const grid = document.getElementById('kanjiGrid');
  const countSpan = document.getElementById('count');
  const selectionScreen = document.getElementById('selectionScreen');
  const drillScreen = document.getElementById('drillScreen');
  const kanjiPool = document.getElementById('kanjiPool');
  const dropZones = document.getElementById('dropZones');
  const timerEl = document.getElementById('timer');
  const progressEl = document.getElementById('progress');

  let activeTile = null;
  let solved = 0;
  let startTime = null;
  let rafId = null;

  function renderGrid() {
    grid.innerHTML = '';
    const levels = [];
    if (document.getElementById('toggleN5').checked) levels.push('N5');
    if (document.getElementById('toggleN4').checked) levels.push('N4');
    if (document.getElementById('toggleN3').checked) levels.push('N3');

    levels.forEach(level => {
      (kanjiData[level] || []).forEach(entry => {
        const tile = document.createElement('div');
        tile.className = 'kanjiTile';
        tile.textContent = entry.k;

        tile.onclick = () => {
          tile.classList.toggle('selected');
          updateCount();
        };

        tile.dataset.kanji = entry.k;
        tile.dataset.on = entry.on;
        tile.dataset.kun = entry.kun;
        grid.appendChild(tile);
      });
    });
    updateCount();
  }

  function updateCount() {
    countSpan.textContent = `Selected: ${document.querySelectorAll('.kanjiTile.selected').length}`;
  }

  function startTimer() {
    startTime = performance.now();
    function tick(t) {
      timerEl.textContent = `Time: ${((t - startTime)/1000).toFixed(1)}s`;
      rafId = requestAnimationFrame(tick);
    }
    rafId = requestAnimationFrame(tick);
  }

  function stopTimer() {
    if (rafId) cancelAnimationFrame(rafId);
  }

  function startDrill() {
    const selected = [...document.querySelectorAll('.kanjiTile.selected')].map(t => ({
      k: t.dataset.kanji,
      on: t.dataset.on,
      kun: t.dataset.kun
    }));
    if (!selected.length) return;

    selectionScreen.classList.add('hidden');
    drillScreen.classList.remove('hidden');

    kanjiPool.innerHTML = '';
    dropZones.innerHTML = '';
    solved = 0;
    progressEl.textContent = `0 / ${selected.length}`;

    selected.forEach(entry => {
      const tile = document.createElement('div');
      tile.className = 'draggableKanji';
      tile.textContent = entry.k;
      tile.onclick = () => selectTile(tile);
      tile.dataset.answer = entry.k;
      kanjiPool.appendChild(tile);

      const zone = document.createElement('div');
      zone.className = 'dropZone';
      zone.dataset.answer = entry.k;
      zone.innerHTML = `<div class="reading">ON: ${entry.on}<br>KUN: ${entry.kun || 'â€”'}</div>`;
      zone.onclick = () => tryDrop(zone);
      dropZones.appendChild(zone);
    });

    startTimer();
  }

  function selectTile(tile) {
    document.querySelectorAll('.draggableKanji').forEach(t => t.classList.remove('active'));
    activeTile = tile;
    tile.classList.add('active');
  }

  function tryDrop(zone) {
    if (!activeTile) return;
    if (zone.dataset.answer === activeTile.dataset.answer) {
      zone.classList.add('correct');
      zone.appendChild(activeTile);
      activeTile.classList.remove('active');
      activeTile.onclick = null;
      activeTile = null;
      solved++;
      progressEl.textContent = `${solved} / ${dropZones.children.length}`;
      if (solved === dropZones.children.length) stopTimer();
    }
  }

  document.getElementById('toggleN5').onchange = renderGrid;
  document.getElementById('toggleN4').onchange = renderGrid;
  document.getElementById('toggleN3').onchange = renderGrid;
  document.getElementById('selectAll').onclick = () => document.querySelectorAll('.kanjiTile').forEach(t => t.classList.add('selected'));
  document.getElementById('clearAll').onclick = () => document.querySelectorAll('.kanjiTile').forEach(t => t.classList.remove('selected'));
  document.getElementById('startDrill').onclick = startDrill;

  renderGrid();
</script>
</body>
</html>
