<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JLPT Kanji Matcher</title>
  <style>
    :root { --gap: 16px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 16px; background:#fafafa; }
    h1, h2 { margin: 8px 0; }
    .hidden { display: none; }
    .levels { display: flex; gap: 12px; flex-wrap: wrap; }
    .levels label { background:#fff; padding:8px 12px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); cursor:pointer; }
    .kanji-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(56px, 1fr)); gap: 10px; margin-top: 12px; }
    .tile { user-select:none; text-align:center; padding:14px 6px; border-radius:12px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.1); font-size:22px; cursor:pointer; }
    .tile.reading { font-size:20px; }
    .tile.selected { background:#ffe58a; }
    .tile.matched { background:#9be7b4; }
    .play-area { margin-top: 18px; }
    .top-row { display:grid; grid-template-columns: repeat(auto-fill, minmax(56px, 1fr)); gap: 10px; }
    .bottom-row { margin-top: var(--gap); display:grid; grid-template-columns: repeat(auto-fill, minmax(56px, 1fr)); gap: 10px; }
    .controls { margin-top: 16px; display:flex; gap:12px; }
    button { padding:10px 14px; border-radius:10px; border:none; background:#222; color:#fff; cursor:pointer; }
  </style>
</head>
<body>
  <h1>JLPT Kanji Matcher</h1>

  <!-- START SCREEN -->
  <section id="start">
    <h2>Select level(s)</h2>
    <div class="levels">
      <label><input type="checkbox" value="N5" /> N5</label>
      <label><input type="checkbox" value="N4" /> N4</label>
      <label><input type="checkbox" value="N3" /> N3</label>
    </div>

    <h2>Choose kanji to drill</h2>
    <div id="selectionGrid" class="kanji-grid"></div>

    <div class="controls">
      <button id="startBtn">Start</button>
    </div>
  </section>

  <!-- GAME SCREEN -->
  <section id="game" class="hidden">
    <div class="play-area">
      <div id="topRow" class="top-row"></div>
      <div id="bottomRow" class="bottom-row"></div>
    </div>
    <div class="controls">
      <button id="backBtn">Back to selection</button>
    </div>
  </section>

  <script>
    // -------- DATA (sample; extend safely) --------
    const KANJI = {
      N5: [
        { k: '一', on: 'イチ', kun: 'ひと' },
        { k: '二', on: 'ニ', kun: 'ふた' },
        { k: '三', on: 'サン', kun: 'み' },
        { k: '四', on: 'ヨン', kun: 'よ' },
        { k: '五', on: 'ゴ', kun: 'いつ' },
        { k: '六', on: 'ロク', kun: 'む' }
      ],
      N4: [
        { k: '会', on: 'カイ', kun: 'あ' },
        { k: '社', on: 'シャ', kun: '' },
        { k: '駅', on: 'エキ', kun: '' },
        { k: '店', on: 'テン', kun: 'みせ' },
        { k: '病', on: 'ビョウ', kun: 'やまい' },
        { k: '院', on: 'イン', kun: '' }
      ],
      N3: [
        { k: '政', on: 'セイ', kun: '' },
        { k: '治', on: 'チ', kun: 'おさ' },
        { k: '経', on: 'ケイ', kun: '' },
        { k: '済', on: 'サイ', kun: '' },
        { k: '法', on: 'ホウ', kun: '' },
        { k: '律', on: 'リツ', kun: '' }
      ]
    };

    const CHUNK_SIZE = 6;

    // -------- STATE --------
    let selectedLevels = new Set();
    let selectedKanji = [];
    let currentChunk = [];
    let selectedTop = null;

    // -------- ELEMENTS --------
    const startEl = document.getElementById('start');
    const gameEl = document.getElementById('game');
    const selectionGrid = document.getElementById('selectionGrid');
    const topRow = document.getElementById('topRow');
    const bottomRow = document.getElementById('bottomRow');

    // -------- HELPERS --------
    function shuffle(arr) {
      return arr.slice().sort(() => Math.random() - 0.5);
    }

    function readingOf(item) {
      return item.kun || item.on;
    }

    function getLevelSelection() {
      return Array.from(document.querySelectorAll('.levels input:checked')).map(i => i.value);
    }

    // -------- START SCREEN LOGIC --------
    function renderSelection() {
      selectionGrid.innerHTML = '';
      const levels = getLevelSelection();
      let pool = [];
      levels.forEach(l => pool = pool.concat(KANJI[l] || []));
      pool.forEach(item => {
        const d = document.createElement('div');
        d.className = 'tile';
        d.textContent = item.k;
        d.onclick = () => {
          d.classList.toggle('selected');
          if (selectedKanji.includes(item)) {
            selectedKanji = selectedKanji.filter(x => x !== item);
          } else {
            selectedKanji.push(item);
          }
        };
        selectionGrid.appendChild(d);
      });
    }

    document.querySelectorAll('.levels input').forEach(cb => cb.addEventListener('change', () => {
      selectedKanji = [];
      renderSelection();
    }));

    document.getElementById('startBtn').onclick = () => {
      if (!selectedKanji.length) return alert('Select at least one kanji');
      startEl.classList.add('hidden');
      gameEl.classList.remove('hidden');
      loadChunk();
    };

    // -------- GAME LOGIC --------
    function loadChunk() {
      topRow.innerHTML = '';
      bottomRow.innerHTML = '';
      selectedTop = null;
      currentChunk = shuffle(selectedKanji).slice(0, CHUNK_SIZE);

      shuffle(currentChunk).forEach(item => {
        const k = document.createElement('div');
        k.className = 'tile';
        k.textContent = item.k;
        k.onclick = () => selectTop(k, item);
        topRow.appendChild(k);
      });

      shuffle(currentChunk).forEach(item => {
        const r = document.createElement('div');
        r.className = 'tile reading';
        r.textContent = readingOf(item);
        r.onclick = () => tryMatch(r, item);
        bottomRow.appendChild(r);
      });
    }

    function selectTop(el, item) {
      document.querySelectorAll('.top-row .tile').forEach(t => t.classList.remove('selected'));
      el.classList.add('selected');
      selectedTop = { el, item };
    }

    function tryMatch(readingEl, item) {
      if (!selectedTop) return;
      if (selectedTop.item === item) {
        // overwrite reading with kanji
        readingEl.textContent = item.k;
        readingEl.classList.add('matched');
        selectedTop.el.remove(); // top kanji disappears
        selectedTop = null;
      }
    }

    document.getElementById('backBtn').onclick = () => {
      gameEl.classList.add('hidden');
      startEl.classList.remove('hidden');
      topRow.innerHTML = '';
      bottomRow.innerHTML = '';
    };

    // -------- BASIC TESTS --------
    console.assert(CHUNK_SIZE === 6, 'Chunk size should be 6');
    console.assert(typeof shuffle([1,2,3])[0] !== 'undefined', 'Shuffle works');
  </script>
</body>
</html>
