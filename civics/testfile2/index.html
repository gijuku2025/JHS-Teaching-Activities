<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>JLPT Kanji Drag Drill</title>
<style>
    body { font-family: -apple-system, BlinkMacSystemFont, system-ui, "Segoe UI", sans-serif; margin: 0; background:#f5f5f5; }
    h1,h2 { margin:0.5em 0; }
    button { padding:12px 16px; font-size:16px; cursor:pointer; border-radius:10px; }
    .hidden{display:none;}

    #selectionScreen{ padding:14px; }
    #controls{ position:sticky; top:0; background:#fff; padding:10px; border-bottom:1px solid #ccc; display:flex; gap:10px; flex-wrap:wrap; align-items:center; z-index:10; }
    #kanjiGrid{ margin-top:16px; display:grid; grid-template-columns:repeat(auto-fill,minmax(52px,1fr)); gap:10px; }
    .kanjiTile{ background:#fff; border:2px solid #ccc; text-align:center; padding:10px 0; font-size:26px; cursor:pointer; user-select:none; border-radius:12px; }
    .kanjiTile.selected{ background:#d0ebff; border-color:#339af0; }

    #drillScreen{ padding:14px; }
    #topBar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; font-size:16px; }
    #drillArea{ display:flex; flex-direction:column; gap:20px; }
    #kanjiPool{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }

    .draggableKanji{ background:#fff; border:3px solid #333; font-size:36px; width:72px; height:72px; display:flex; align-items:center; justify-content:center; border-radius:14px; cursor:pointer; }
    .draggableKanji.active{ background:#fff3bf; border-color:#f59f00; }

    #dropZones{ display:flex; flex-direction:column; gap:12px; }
    .dropZone{ background:#fff; border:3px dashed #999; padding:12px; min-height:72px; border-radius:14px; display:flex; justify-content:space-between; align-items:center; font-size:15px; }
    .dropZone.correct{ border-color:#2f9e44; background:#e6ffe6; }
    .reading{ font-size:14px; line-height:1.4; }
  </style>
</head>
<body>

<div id="selectionScreen">
  <h1>JLPT Kanji Drill</h1>
  <div id="controls">
    <label><input type="checkbox" id="toggleN5" checked> N5</label>
    <label><input type="checkbox" id="toggleN4"> N4</label>
    <label><input type="checkbox" id="toggleN3"> N3</label>
    <button id="selectAll">Select All</button>
    <button id="clearAll">Clear</button>
    <span id="count">Selected: 0</span>
    <button id="startDrill">Start</button>
  </div>
  <div id="kanjiGrid"></div>
</div>

<div id="drillScreen" class="hidden">
  <div id="topBar">
    <div id="timer">Time: 0.0s</div>
    <div id="progress"></div>
  </div>
  <div id="drillArea">
    <div id="kanjiPool"></div>
    <div id="dropZones"></div>
  </div>
</div>

<script>
  /* ===== Kanji Data ===== */
  const kanjiData = {
    N5: [
      {k:'一',on:'イチ',kun:'ひと-'},{k:'二',on:'ニ',kun:'ふた-'},{k:'三',on:'サン',kun:'み-'},{k:'四',on:'ヨン',kun:'よ-'},{k:'五',on:'ゴ',kun:'いつ-'},
      {k:'六',on:'ロク',kun:'む-'},{k:'七',on:'ナナ',kun:'なな'},{k:'八',on:'ハチ',kun:'や-'},{k:'九',on:'キュウ',kun:'ここの-'},{k:'十',on:'ジュウ',kun:'とお'},
      {k:'日',on:'ニチ',kun:'ひ'},{k:'月',on:'ゲツ',kun:'つき'},{k:'火',on:'カ',kun:'ひ'},{k:'水',on:'スイ',kun:'みず'},{k:'木',on:'モク',kun:'き'},
      {k:'人',on:'ジン',kun:'ひと'},{k:'大',on:'ダイ',kun:'おお-'},{k:'小',on:'ショウ',kun:'ちい-'},{k:'中',on:'チュウ',kun:'なか'},
      {k:'行',on:'コウ',kun:'い-く'},{k:'来',on:'ライ',kun:'く-る'},{k:'見',on:'ケン',kun:'み-る'},
      {k:'食',on:'ショク',kun:'た-べる'},{k:'飲',on:'イン',kun:'の-む'},
      {k:'学',on:'ガク',kun:'まな-ぶ'},{k:'校',on:'コウ',kun:''}
    ],
    N4: [
      {k:'会',on:'カイ',kun:'あ-う'},{k:'社',on:'シャ',kun:''},{k:'店',on:'テン',kun:'みせ'},{k:'駅',on:'エキ',kun:''},
      {k:'思',on:'シ',kun:'おも-う'},{k:'作',on:'サク',kun:'つく-る'},{k:'使',on:'シ',kun:'つか-う'},
      {k:'借',on:'シャク',kun:'か-りる'},{k:'住',on:'ジュウ',kun:'す-む'},{k:'知',on:'チ',kun:'し-る'},
      {k:'強',on:'キョウ',kun:'つよ-い'},{k:'弱',on:'ジャク',kun:'よわ-い'},
      {k:'始',on:'シ',kun:'はじ-める'},{k:'終',on:'シュウ',kun:'お-わる'}
    ],
    N3: [
      {k:'政',on:'セイ',kun:''},{k:'治',on:'ジ',kun:'おさ-める'},{k:'経',on:'ケイ',kun:'へ-る'},
      {k:'法',on:'ホウ',kun:''},{k:'情',on:'ジョウ',kun:'なさ-け'},{k:'決',on:'ケツ',kun:'き-める'},
      {k:'変',on:'ヘン',kun:'か-わる'},{k:'関',on:'カン',kun:'かか-わる'},
      {k:'表',on:'ヒョウ',kun:'あらわ-す'},{k:'認',on:'ニン',kun:'みと-める'},
      {k:'必',on:'ヒツ',kun:'かなら-ず'}
    ]
  };

  const grid = document.getElementById('kanjiGrid');
  const countSpan = document.getElementById('count');
  const selectionScreen = document.getElementById('selectionScreen');
  const drillScreen = document.getElementById('drillScreen');
  const kanjiPool = document.getElementById('kanjiPool');
  const dropZones = document.getElementById('dropZones');
  const timerEl = document.getElementById('timer');
  const progressEl = document.getElementById('progress');

  let activeTile = null;
  let solved = 0;
  let chunks = [];
  let currentChunkIndex = 0;
  let startTime = null;
  let rafId = null;

  function renderGrid() {
    grid.innerHTML = '';
    const levels = [];
    if (document.getElementById('toggleN5').checked) levels.push('N5');
    if (document.getElementById('toggleN4').checked) levels.push('N4');
    if (document.getElementById('toggleN3').checked) levels.push('N3');

    levels.forEach(level => {
      (kanjiData[level] || []).forEach(entry => {
        const tile = document.createElement('div');
        tile.className = 'kanjiTile';
        tile.textContent = entry.k;
        tile.onclick = () => {
          tile.classList.toggle('selected');
          updateCount();
        };
        tile.dataset.kanji = entry.k;
        tile.dataset.on = entry.on;
        tile.dataset.kun = entry.kun;
        grid.appendChild(tile);
      });
    });
    updateCount();

    // simple sanity check
    console.assert(grid.children.length > 0 || (!document.getElementById('toggleN5').checked && !document.getElementById('toggleN4').checked && !document.getElementById('toggleN3').checked), 'Kanji grid failed to render');
  }

  function updateCount() {
    countSpan.textContent = `Selected: ${document.querySelectorAll('.kanjiTile.selected').length}`;
  }

  function startTimer() {
    startTime = performance.now();
    function tick(t) {
      timerEl.textContent = `Time: ${((t - startTime)/1000).toFixed(1)}s`;
      rafId = requestAnimationFrame(tick);
    }
    rafId = requestAnimationFrame(tick);
  }

  function stopTimer() {
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
  }

  function startDrill() {
    const selected = [...document.querySelectorAll('.kanjiTile.selected')].map(t => ({
      k: t.dataset.kanji,
      on: t.dataset.on,
      kun: t.dataset.kun
    }));
    if (!selected.length) return;

    chunks = [];
    for (let i = 0; i < selected.length; i += 10) chunks.push(selected.slice(i, i + 10));
    currentChunkIndex = 0;

    selectionScreen.classList.add('hidden');
    drillScreen.classList.remove('hidden');

    loadChunk();
  }

  function loadChunk() {
    stopTimer();
    kanjiPool.innerHTML = '';
    dropZones.innerHTML = '';
    solved = 0;

    const chunk = chunks[currentChunkIndex];
    progressEl.textContent = `Chunk ${currentChunkIndex + 1} / ${chunks.length} — 0 / ${chunk.length}`;

    chunk.forEach(entry => {
      const tile = document.createElement('div');
      tile.className = 'draggableKanji';
      tile.textContent = entry.k;
      tile.onclick = () => selectTile(tile);
      tile.dataset.answer = entry.k;
      kanjiPool.appendChild(tile);

      const zone = document.createElement('div');
      zone.className = 'dropZone';
      zone.dataset.answer = entry.k;
      zone.innerHTML = `<div class="reading">ON: ${entry.on}<br>KUN: ${entry.kun || '—'}</div>`;
      zone.onclick = () => tryDrop(zone);
      dropZones.appendChild(zone);
    });

    startTimer();
  }

  function selectTile(tile) {
    document.querySelectorAll('.draggableKanji').forEach(t => t.classList.remove('active'));
    activeTile = tile;
    tile.classList.add('active');
  }

  function tryDrop(zone) {
    if (!activeTile) return;
    if (zone.dataset.answer === activeTile.dataset.answer) {
      zone.classList.add('correct');
      zone.appendChild(activeTile);
      activeTile.classList.remove('active');
      activeTile.onclick = null;
      activeTile = null;
      solved++;

      const total = dropZones.children.length;
      progressEl.textContent = `Chunk ${currentChunkIndex + 1} / ${chunks.length} — ${solved} / ${total}`;

      if (solved === total) {
        stopTimer();
        currentChunkIndex++;
        if (currentChunkIndex < chunks.length) {
          setTimeout(loadChunk, 500);
        } else {
          progressEl.textContent = 'Session complete';
        }
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('toggleN5').onchange = renderGrid;
    document.getElementById('toggleN4').onchange = renderGrid;
    document.getElementById('toggleN3').onchange = renderGrid;
    document.getElementById('selectAll').onclick = () => {
      document.querySelectorAll('.kanjiTile').forEach(t => t.classList.add('selected'));
      updateCount();
    };
    document.getElementById('clearAll').onclick = () => {
      document.querySelectorAll('.kanjiTile').forEach(t => t.classList.remove('selected'));
      updateCount();
    };
    document.getElementById('startDrill').onclick = startDrill;

    renderGrid();
  });
</script>
</body>
</html>
